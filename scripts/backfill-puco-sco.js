#!/usr/bin/env node
/**
 * PUCO SCO Historical Rate Backfill — Ohio Rate Watch (PostgreSQL version)
 *
 * Generated by: Claude Sonnet (subagent, PUCO SCO Backfill)
 * Date: 2026-02-25
 * Updated: 2026-02-26 (migrated to PostgreSQL)
 */

import pg from 'pg';
import { readFileSync, existsSync } from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const DRY_RUN = process.argv.includes('--dry-run');

let DATABASE_URL = process.env.DATABASE_URL;
if (!DATABASE_URL) {
  const envPath = path.join(__dirname, '..', '.env');
  if (existsSync(envPath)) {
    DATABASE_URL = readFileSync(envPath, 'utf8').match(/DATABASE_URL=(.*)/)?.[1]?.trim();
  }
}
if (!DATABASE_URL) { console.error('No DATABASE_URL'); process.exit(1); }

console.log(`[backfill] Mode: ${DRY_RUN ? 'DRY RUN' : 'LIVE'}`);

// Columbia Gas of Ohio — territory_id=8
const COLUMBIA_GAS = {
  territory_id: 8, name: 'Columbia Gas of Ohio',
  data: [
    ['2018-01-01',0.3932],['2018-02-01',0.5081],['2018-03-01',0.5081],['2018-04-01',0.9321],['2018-05-01',0.4051],['2018-06-01',0.4105],['2018-07-01',0.4226],['2018-08-01',0.4052],['2018-09-01',0.4125],['2018-10-01',0.4251],['2018-11-01',0.4415],['2018-12-01',0.5945],
    ['2019-01-01',0.4872],['2019-02-01',0.4180],['2019-03-01',0.4085],['2019-04-01',0.3893],['2019-05-01',0.3746],['2019-06-01',0.3813],['2019-07-01',0.3471],['2019-08-01',0.3321],['2019-09-01',0.3431],['2019-10-01',0.3608],['2019-11-01',0.3777],['2019-12-01',0.6500],
    ['2020-01-01',0.3338],['2020-02-01',0.3057],['2020-03-01',0.3001],['2020-04-01',0.2700],['2020-05-01',0.2864],['2020-06-01',0.2792],['2020-07-01',0.2565],['2020-08-01',0.2924],['2020-09-01',0.3649],['2020-10-01',0.3171],['2020-11-01',0.4066],['2020-12-01',0.3966],
    ['2021-01-01',0.3537],['2021-02-01',0.3830],['2021-03-01',0.3924],['2021-04-01',0.4286],['2021-05-01',0.4625],['2021-06-01',0.4684],['2021-07-01',0.5317],['2021-08-01',0.6070],['2021-09-01',0.7541],['2021-10-01',0.7902],['2021-11-01',0.7147],['2021-12-01',0.7147],
    ['2022-01-01',0.5724],['2022-02-01',0.7965],['2022-03-01',0.6268],['2022-04-01',0.6986],['2022-05-01',0.8917],['2022-06-01',1.0558],['2022-07-01',0.8201],['2022-08-01',1.0337],['2022-09-01',1.1003],['2022-10-01',0.8518],['2022-11-01',0.6836],['2022-12-01',0.8362],
    ['2023-01-01',0.6350],['2023-02-01',0.4750],['2023-03-01',0.4100],['2023-04-01',0.3790],['2023-05-01',0.3910],['2023-06-01',0.3980],['2023-07-01',0.4400],['2023-08-01',0.4290],['2023-09-01',0.4350],['2023-10-01',0.4560],['2023-11-01',0.4964],['2023-12-01',0.4506],
    ['2024-01-01',0.4419],['2024-02-01',0.4290],['2024-03-01',0.3415],['2024-04-01',0.3235],['2024-05-01',0.3274],['2024-06-01',0.4153],['2024-07-01',0.4288],['2024-08-01',0.3567],['2024-09-01',0.3590],['2024-10-01',0.4245],['2024-11-01',0.4006],['2024-12-01',0.5091],
    ['2025-01-01',0.5174],['2025-02-01',0.5195],['2025-03-01',0.5566],['2025-04-01',0.7200],['2025-05-01',0.6420],['2025-06-01',0.6454],['2025-07-01',0.6511],['2025-08-01',0.6331],['2025-09-01',0.6117],['2025-10-01',0.6085],['2025-11-01',0.6626],['2025-12-01',0.7674],
    ['2026-01-01',0.7937],['2026-02-01',1.0710],
  ]
};

const ENBRIDGE_GAS = {
  territory_id: 1, name: 'Enbridge Gas Ohio',
  data: [
    ['2018-05-01',0.289],['2018-06-01',0.295],['2018-07-01',0.307],['2018-08-01',0.289],['2018-09-01',0.297],['2018-10-01',0.309],['2018-11-01',0.326],['2018-12-01',0.479],
    ['2019-01-01',0.371],['2019-02-01',0.302],['2019-03-01',0.293],['2019-04-01',0.293],['2019-05-01',0.279],['2019-06-01',0.285],['2019-07-01',0.251],['2019-08-01',0.236],['2019-09-01',0.247],['2019-10-01',0.265],['2019-11-01',0.282],['2019-12-01',0.269],
    ['2020-01-01',0.238],['2020-02-01',0.210],['2020-03-01',0.204],['2020-04-01',0.178],['2020-05-01',0.187],['2020-06-01',0.187],['2020-07-01',0.165],['2020-08-01',0.200],['2020-09-01',0.273],['2020-10-01',0.225],['2020-11-01',0.315],['2020-12-01',0.305],
    ['2021-01-01',0.262],['2021-02-01',0.291],['2021-03-01',0.300],['2021-04-01',0.274],['2021-05-01',0.308],['2021-06-01',0.313],['2021-07-01',0.377],['2021-08-01',0.419],['2021-09-01',0.452],['2021-10-01',0.599],['2021-11-01',0.635],['2021-12-01',0.560],
    ['2022-01-01',0.417],['2022-02-01',0.642],['2022-03-01',0.472],['2022-04-01',0.552],['2022-05-01',0.745],['2022-06-01',0.909],['2022-07-01',0.673],['2022-08-01',0.887],['2022-09-01',0.953],['2022-10-01',0.705],['2022-11-01',0.536],['2022-12-01',0.689],
    ['2023-01-01',0.489],['2023-02-01',0.329],['2023-03-01',0.263],['2023-04-01',0.238],['2023-05-01',0.251],['2023-06-01',0.257],['2023-07-01',0.299],['2023-08-01',0.288],['2023-09-01',0.295],['2023-10-01',0.315],['2023-11-01',0.355],['2023-12-01',0.310],
    ['2024-01-01',0.301],['2024-02-01',0.288],['2024-03-01',0.201],['2024-04-01',0.178],['2024-05-01',0.181],['2024-06-01',0.269],['2024-07-01',0.283],['2024-08-01',0.211],['2024-09-01',0.213],['2024-10-01',0.279],['2024-11-01',0.255],['2024-12-01',0.363],
    ['2025-01-01',0.371],['2025-02-01',0.374],['2025-03-01',0.411],['2025-04-01',0.445],['2025-05-01',0.367],['2025-06-01',0.370],['2025-07-01',0.376],['2025-08-01',0.358],['2025-09-01',0.337],['2025-10-01',0.334],['2025-11-01',0.388],['2025-12-01',0.492],
    ['2026-01-01',0.519],['2026-02-01',0.796],
  ]
};

const CENTERPOINT = {
  territory_id: 11, name: 'CenterPoint Energy Ohio',
  data: [
    ['2018-05-01',0.39],['2018-06-01',0.39],['2018-07-01',0.41],['2018-08-01',0.39],['2018-09-01',0.40],['2018-10-01',0.41],['2018-11-01',0.43],['2018-12-01',0.59],
    ['2019-01-01',0.48],['2019-02-01',0.40],['2019-03-01',0.39],['2019-04-01',0.38],['2019-05-01',0.36],['2019-06-01',0.37],['2019-07-01',0.33],['2019-08-01',0.31],['2019-09-01',0.33],['2019-10-01',0.34],['2019-11-01',0.36],['2019-12-01',0.35],
    ['2020-01-01',0.32],['2020-02-01',0.29],['2020-03-01',0.28],['2020-04-01',0.25],['2020-05-01',0.27],['2020-06-01',0.26],['2020-07-01',0.23],['2020-08-01',0.27],['2020-09-01',0.35],['2020-10-01',0.30],['2020-11-01',0.40],['2020-12-01',0.38],
    ['2021-01-01',0.34],['2021-02-01',0.37],['2021-03-01',0.38],['2021-04-01',0.39],['2021-05-01',0.43],['2021-06-01',0.44],['2021-07-01',0.50],['2021-08-01',0.55],['2021-09-01',0.58],['2021-10-01',0.74],['2021-11-01',0.78],['2021-12-01',0.70],
    ['2022-01-01',0.55],['2022-02-01',0.79],['2022-03-01',0.60],['2022-04-01',0.68],['2022-05-01',0.88],['2022-06-01',1.06],['2022-07-01',0.81],['2022-08-01',1.04],['2022-09-01',1.11],['2022-10-01',0.84],['2022-11-01',0.66],['2022-12-01',0.83],
    ['2023-01-01',0.61],['2023-02-01',0.44],['2023-03-01',0.37],['2023-04-01',0.31],['2023-05-01',0.33],['2023-06-01',0.33],['2023-07-01',0.38],['2023-08-01',0.37],['2023-09-01',0.37],['2023-10-01',0.40],['2023-11-01',0.44],['2023-12-01',0.39],
    ['2024-01-01',0.38],['2024-02-01',0.37],['2024-03-01',0.27],['2024-04-01',0.30],['2024-05-01',0.30],['2024-06-01',0.40],['2024-07-01',0.41],['2024-08-01',0.33],['2024-09-01',0.34],['2024-10-01',0.41],['2024-11-01',0.38],['2024-12-01',0.50],
    ['2025-01-01',0.51],['2025-02-01',0.51],['2025-03-01',0.55],['2025-04-01',0.64],['2025-05-01',0.56],['2025-06-01',0.56],['2025-07-01',0.57],['2025-08-01',0.55],['2025-09-01',0.53],['2025-10-01',0.52],['2025-11-01',0.58],['2025-12-01',0.69],
    ['2026-01-01',0.72],['2026-02-01',1.02],
  ]
};

const UTILITIES = [COLUMBIA_GAS, ENBRIDGE_GAS, CENTERPOINT];

async function main() {
  const pool = new pg.Pool({ connectionString: DATABASE_URL });

  // Ensure table exists
  await pool.query(`
    CREATE TABLE IF NOT EXISTS rate_history (
      id SERIAL PRIMARY KEY,
      territory_id INTEGER NOT NULL,
      date TEXT NOT NULL,
      type TEXT NOT NULL,
      rate REAL NOT NULL,
      source TEXT DEFAULT 'PUCO',
      created_at TIMESTAMPTZ DEFAULT NOW(),
      UNIQUE(territory_id, date, type)
    );
    CREATE INDEX IF NOT EXISTS idx_rate_history_territory_date ON rate_history(territory_id, date);
  `);

  let totalInserted = 0, totalSkipped = 0;

  for (const utility of UTILITIES) {
    let inserted = 0, skipped = 0;
    const client = await pool.connect();
    try {
      await client.query('BEGIN');
      for (const [date, rate] of utility.data) {
        if (DRY_RUN) { inserted++; continue; }
        const res = await client.query(
          `INSERT INTO rate_history (territory_id, date, type, rate, source) VALUES ($1,$2,$3,$4,$5) ON CONFLICT DO NOTHING`,
          [utility.territory_id, date, 'sco', rate, 'PUCO']
        );
        if (res.rowCount > 0) inserted++; else skipped++;
      }
      await client.query('COMMIT');
    } finally {
      client.release();
    }
    console.log(`[backfill] ${utility.name} (territory_id=${utility.territory_id}): ${inserted} inserted, ${skipped} skipped`);
    totalInserted += inserted;
    totalSkipped += skipped;
  }

  console.log(`\n[backfill] Total: ${totalInserted} inserted, ${totalSkipped} skipped`);

  if (!DRY_RUN) {
    const counts = await pool.query(`SELECT territory_id, count(*) as cnt FROM rate_history WHERE type='sco' GROUP BY territory_id ORDER BY territory_id`);
    console.log('\n[backfill] Verification:');
    for (const row of counts.rows) {
      const name = UTILITIES.find(u => u.territory_id === row.territory_id)?.name || 'Unknown';
      console.log(`  territory_id=${row.territory_id} (${name}): ${row.cnt} rows`);
    }
  }

  await pool.end();
  console.log('\n[backfill] Done.');
}

main().catch(err => { console.error('[backfill] FATAL:', err); process.exit(1); });
