#!/usr/bin/env node
/**
 * EIA Historical Data Backfill — Ohio Rate Watch
 *
 * Backfills the rate_snapshots table with:
 * 1. Ohio residential NG avg price (EIA N3010OH3) as SCO proxy → sco_rate column
 * 2. Henry Hub spot price (EIA RNGWHHD) as a reference series
 *
 * EIA Ohio data: monthly, $/Mcf → converted to $/ccf (÷10)
 * Henry Hub: daily, $/MMBtu (stored as-is for reference)
 *
 * Usage:
 *   node backfill-eia-history.js [--dry-run]
 *
 * Expects to run from /opt/ratewatch-api/ or wherever better-sqlite3 + data/ lives.
 *
 * Generated by: Opus (sub-agent, EIA Backfill Pipeline)
 * Date: 2026-02-25
 */

import Database from 'better-sqlite3';
import { readFileSync, existsSync } from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const DRY_RUN = process.argv.includes('--dry-run');

// Resolve DB path — works from project root or scripts/
const DB_PATH = existsSync(path.join(__dirname, '..', 'data', 'rates-history.db'))
  ? path.join(__dirname, '..', 'data', 'rates-history.db')
  : path.join(__dirname, 'data', 'rates-history.db');

console.log(`[backfill] DB: ${DB_PATH}`);
console.log(`[backfill] Mode: ${DRY_RUN ? 'DRY RUN' : 'LIVE'}`);

// --- Load EIA data from bundled JSON or fetch live ---
async function loadEIAData() {
  // Try local JSON files first (for dev), then fetch from EIA XLS
  const dataDir = path.join(__dirname, '..', 'data-research');
  const ohioPath = path.join(dataDir, 'eia-ohio-prices-full.json');
  const hhPath = path.join(dataDir, 'eia-henry-hub-full.json');

  let ohio, henryHub;

  if (existsSync(ohioPath) && existsSync(hhPath)) {
    console.log('[backfill] Loading from local JSON files...');
    ohio = JSON.parse(readFileSync(ohioPath, 'utf8'));
    henryHub = JSON.parse(readFileSync(hhPath, 'utf8'));
  } else {
    console.error('[backfill] ERROR: EIA JSON data files not found.');
    console.error(`  Expected: ${ohioPath}`);
    console.error(`  Expected: ${hhPath}`);
    console.error('  Run the data puller first or copy files to data-research/');
    process.exit(1);
  }

  return { ohio, henryHub };
}

// --- Main backfill ---
async function main() {
  const { ohio, henryHub } = await loadEIAData();

  console.log(`[backfill] Ohio records: ${ohio.records.length} (${ohio.records[0]?.date} to ${ohio.records[ohio.records.length - 1]?.date})`);
  console.log(`[backfill] Henry Hub daily records: ${henryHub.records.length}`);

  const db = new Database(DB_PATH);
  db.pragma('journal_mode = WAL');

  // Check what dates already exist
  const existingDates = new Set(
    db.prepare(`SELECT DISTINCT date(scraped_at) as d FROM rate_snapshots`).all().map(r => r.d)
  );
  console.log(`[backfill] Existing dates in DB: ${existingDates.size}`);

  // --- Territory IDs for natural gas (from current data) ---
  // We'll use territory_id=0 for statewide EIA historical data
  const EIA_TERRITORY_ID = 0;
  const EIA_TERRITORY_NAME = 'Ohio Statewide (EIA Historical)';

  const insert = db.prepare(`
    INSERT INTO rate_snapshots
      (scraped_at, category, territory_id, territory_name, rate_code,
       sco_rate, supplier_name, price, rate_type, term_months, etf, monthly_fee, renewable_pct)
    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
  `);

  let ohioInserted = 0;
  let ohioSkipped = 0;
  let hhInserted = 0;
  let hhSkipped = 0;

  const runInserts = db.transaction(() => {
    // 1. Ohio residential avg as SCO proxy
    for (const rec of ohio.records) {
      const dateStr = rec.date.substring(0, 10); // YYYY-MM-DD
      // Use first of month for monthly data
      const monthDate = dateStr.substring(0, 7) + '-01';

      // Check for existing EIA data on this month
      const existing = db.prepare(
        `SELECT 1 FROM rate_snapshots WHERE date(scraped_at) = ? AND supplier_name = 'EIA Ohio Residential Avg'`
      ).get(monthDate);

      if (existing) {
        ohioSkipped++;
        continue;
      }

      if (DRY_RUN) {
        ohioInserted++;
        continue;
      }

      // $/Mcf → $/ccf (divide by 10)
      const pricePerCcf = Math.round(rec.value / 10 * 10000) / 10000;

      insert.run(
        monthDate + 'T12:00:00.000Z',  // scraped_at (noon UTC on 1st of month)
        'NaturalGas',                     // category
        EIA_TERRITORY_ID,                 // territory_id
        EIA_TERRITORY_NAME,               // territory_name
        null,                             // rate_code
        pricePerCcf,                      // sco_rate (using residential avg as proxy)
        'EIA Ohio Residential Avg',       // supplier_name
        pricePerCcf,                      // price (same as sco for this reference series)
        'reference',                      // rate_type
        null,                             // term_months
        null,                             // etf
        null,                             // monthly_fee
        null                              // renewable_pct
      );
      ohioInserted++;
    }

    // 2. Henry Hub spot price as reference
    for (const rec of henryHub.records) {
      const dateStr = rec.date.substring(0, 10);

      const existing = db.prepare(
        `SELECT 1 FROM rate_snapshots WHERE date(scraped_at) = ? AND supplier_name = 'Henry Hub Spot Price'`
      ).get(dateStr);

      if (existing) {
        hhSkipped++;
        continue;
      }

      if (DRY_RUN) {
        hhInserted++;
        continue;
      }

      insert.run(
        dateStr + 'T12:00:00.000Z',
        'NaturalGas',
        EIA_TERRITORY_ID,
        EIA_TERRITORY_NAME,
        null,
        null,                             // no sco_rate for henry hub
        'Henry Hub Spot Price',           // supplier_name
        rec.value,                        // price in $/MMBtu
        'reference',                      // rate_type
        null, null, null, null
      );
      hhInserted++;
    }
  });

  runInserts();

  console.log('\n[backfill] Results:');
  console.log(`  Ohio Residential Avg: ${ohioInserted} inserted, ${ohioSkipped} skipped (dedup)`);
  console.log(`  Henry Hub Spot:       ${hhInserted} inserted, ${hhSkipped} skipped (dedup)`);
  console.log(`  Total new rows:       ${ohioInserted + hhInserted}`);

  if (DRY_RUN) {
    console.log('\n[backfill] DRY RUN — no data was written.');
  } else {
    const total = db.prepare('SELECT COUNT(*) as c FROM rate_snapshots').get();
    console.log(`\n[backfill] Total rows in DB now: ${total.c}`);
  }

  db.close();
}

main().catch(err => {
  console.error('[backfill] FATAL:', err);
  process.exit(1);
});
