#!/usr/bin/env node
/**
 * EIA Historical Data Backfill â€” Ohio Rate Watch (PostgreSQL version)
 *
 * Generated by: Opus (sub-agent, EIA Backfill Pipeline)
 * Date: 2026-02-25
 * Updated: 2026-02-26 (migrated to PostgreSQL)
 */

import pg from 'pg';
import { readFileSync, existsSync } from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const DRY_RUN = process.argv.includes('--dry-run');

// Load DATABASE_URL
let DATABASE_URL = process.env.DATABASE_URL;
if (!DATABASE_URL) {
  const envPath = path.join(__dirname, '..', '.env');
  if (existsSync(envPath)) {
    DATABASE_URL = readFileSync(envPath, 'utf8').match(/DATABASE_URL=(.*)/)?.[1]?.trim();
  }
}
if (!DATABASE_URL) { console.error('No DATABASE_URL'); process.exit(1); }

console.log(`[backfill] Mode: ${DRY_RUN ? 'DRY RUN' : 'LIVE'}`);

async function loadEIAData() {
  const dataDir = path.join(__dirname, '..', 'data-research');
  const ohioPath = path.join(dataDir, 'eia-ohio-prices-full.json');
  const hhPath = path.join(dataDir, 'eia-henry-hub-full.json');

  if (existsSync(ohioPath) && existsSync(hhPath)) {
    console.log('[backfill] Loading from local JSON files...');
    return {
      ohio: JSON.parse(readFileSync(ohioPath, 'utf8')),
      henryHub: JSON.parse(readFileSync(hhPath, 'utf8'))
    };
  }
  console.error('[backfill] ERROR: EIA JSON data files not found.');
  process.exit(1);
}

async function main() {
  const { ohio, henryHub } = await loadEIAData();
  console.log(`[backfill] Ohio records: ${ohio.records.length}`);
  console.log(`[backfill] Henry Hub daily records: ${henryHub.records.length}`);

  const pool = new pg.Pool({ connectionString: DATABASE_URL });
  const EIA_TERRITORY_ID = 0;
  const EIA_TERRITORY_NAME = 'Ohio Statewide (EIA Historical)';

  let ohioInserted = 0, ohioSkipped = 0, hhInserted = 0, hhSkipped = 0;

  const client = await pool.connect();
  try {
    await client.query('BEGIN');

    for (const rec of ohio.records) {
      const monthDate = rec.date.substring(0, 7) + '-01';
      const existing = await client.query(
        `SELECT 1 FROM rate_snapshots WHERE scraped_at::date = $1::date AND supplier_name = 'EIA Ohio Residential Avg'`,
        [monthDate]
      );
      if (existing.rows.length > 0) { ohioSkipped++; continue; }
      if (DRY_RUN) { ohioInserted++; continue; }

      const pricePerCcf = Math.round(rec.value / 10 * 10000) / 10000;
      await client.query(`
        INSERT INTO rate_snapshots
          (scraped_at, category, territory_id, territory_name, rate_code,
           sco_rate, supplier_name, price, rate_type, term_months, etf, monthly_fee, renewable_pct)
        VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,$13)
      `, [
        monthDate + 'T12:00:00.000Z', 'NaturalGas', EIA_TERRITORY_ID, EIA_TERRITORY_NAME, null,
        pricePerCcf, 'EIA Ohio Residential Avg', pricePerCcf, 'reference', null, null, null, null
      ]);
      ohioInserted++;
    }

    for (const rec of henryHub.records) {
      const dateStr = rec.date.substring(0, 10);
      const existing = await client.query(
        `SELECT 1 FROM rate_snapshots WHERE scraped_at::date = $1::date AND supplier_name = 'Henry Hub Spot Price'`,
        [dateStr]
      );
      if (existing.rows.length > 0) { hhSkipped++; continue; }
      if (DRY_RUN) { hhInserted++; continue; }

      await client.query(`
        INSERT INTO rate_snapshots
          (scraped_at, category, territory_id, territory_name, rate_code,
           sco_rate, supplier_name, price, rate_type, term_months, etf, monthly_fee, renewable_pct)
        VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,$13)
      `, [
        dateStr + 'T12:00:00.000Z', 'NaturalGas', EIA_TERRITORY_ID, EIA_TERRITORY_NAME, null,
        null, 'Henry Hub Spot Price', rec.value, 'reference', null, null, null, null
      ]);
      hhInserted++;
    }

    await client.query('COMMIT');
  } catch (e) {
    await client.query('ROLLBACK');
    throw e;
  } finally {
    client.release();
  }

  console.log('\n[backfill] Results:');
  console.log(`  Ohio Residential Avg: ${ohioInserted} inserted, ${ohioSkipped} skipped`);
  console.log(`  Henry Hub Spot:       ${hhInserted} inserted, ${hhSkipped} skipped`);

  if (!DRY_RUN) {
    const total = await pool.query('SELECT COUNT(*) as c FROM rate_snapshots');
    console.log(`\n[backfill] Total rows in DB now: ${total.rows[0].c}`);
  }

  await pool.end();
}

main().catch(err => { console.error('[backfill] FATAL:', err); process.exit(1); });
